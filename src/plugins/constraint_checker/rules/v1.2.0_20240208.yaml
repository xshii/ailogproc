# 配置约束规则 v1.2.0
# 创建日期: 2024-02-08
# 描述: 新增字段组合约束功能

version: "1.2.0"
date: "2024-02-08"
description: "新增单组和多组字段组合约束"
author: "Team"
changelog:
  - "新增 only_allow_combinations 支持单组内多字段组合约束"
  - "新增多组间字段组合映射约束"
  - "保留原有的 only_allow、forbid、same_value、sequence 等功能"

# ==================== 单组约束 ====================

single_constraints:
  # 原有约束（保持兼容）
  - name: "系统模式1的配置约束"
    when:
      systemMode: "1"
    only_allow:
      debugLevel: ["0", "1", "2", "3"]
      powerMode: ["low", "medium", "high"]
    forbid:
      dangerousFlag: ["1", "true"]

  - name: "调试模式约束"
    when:
      debugLevel: "3"
      systemMode: "2"
    forbid:
      productionMode: ["1", "enabled"]

  # 新增：功率等级组合约束
  - name: "功率等级组合约束"
    description: "功率、电压、频率必须配套使用"
    when:
      systemMode: "1"

    only_allow_combinations:
      # 低功率配置
      - powerLevel: "5"
        voltageLevel: "1"
        frequencyMode: "low"

      # 中功率配置
      - powerLevel: "10"
        voltageLevel: "2"
        frequencyMode: "medium"

      # 高功率配置
      - powerLevel: "15"
        voltageLevel: "3"
        frequencyMode: "high"

  # 新增：温度-风扇组合约束
  - name: "散热配置组合约束"
    description: "温度阈值、功率限制、风扇转速必须协调"

    only_allow_combinations:
      # 低温场景：60°C
      - tempThreshold: "60"
        maxPower: "100W"
        fanSpeed: "30%"

      # 中温场景：75°C
      - tempThreshold: "75"
        maxPower: "80W"
        fanSpeed: "60%"

      # 高温场景：85°C
      - tempThreshold: "85"
        maxPower: "60W"
        fanSpeed: "100%"

# ==================== 多组约束 ====================

multi_constraints:
  # 原有约束（保持兼容）
  - name: "连续两组systemMode一致性"
    group_count: 2
    rules:
      - type: "same_value"
        field: "systemMode"

  - name: "三组配置ID递增检查"
    group_count: 3
    rules:
      - type: "sequence"
        field: "configId"
        order: "increasing"

  - name: "级联功率控制"
    group_count: 3
    rules:
      - type: "conditional"
        when_group: 0
        when_field: "powerMode"
        when_value: "high"
        then_group: 1
        then_field: "powerMode"
        forbid: ["low"]

      - type: "conditional"
        when_group: 1
        when_field: "powerMode"
        when_value: "high"
        then_group: 2
        then_field: "powerMode"
        forbid: ["low"]

  # 新增：功率等级切换规则
  - name: "功率等级切换规则"
    description: "定义允许的功率等级切换路径，防止直接从高功率跳到低功率"
    group_count: 2

    only_allow_combinations:
      # ===== 从低功率(5)可以切换到的配置 =====
      # 低→低（保持）
      - group0:
          powerLevel: "5"
          voltageLevel: "1"
          frequencyMode: "low"
        group1:
          powerLevel: "5"
          voltageLevel: "1"
          frequencyMode: "low"

      # 低→中（提升）
      - group0:
          powerLevel: "5"
          voltageLevel: "1"
          frequencyMode: "low"
        group1:
          powerLevel: "10"
          voltageLevel: "2"
          frequencyMode: "medium"

      # ===== 从中功率(10)可以切换到的配置 =====
      # 中→低（降低）
      - group0:
          powerLevel: "10"
          voltageLevel: "2"
          frequencyMode: "medium"
        group1:
          powerLevel: "5"
          voltageLevel: "1"
          frequencyMode: "low"

      # 中→中（保持）
      - group0:
          powerLevel: "10"
          voltageLevel: "2"
          frequencyMode: "medium"
        group1:
          powerLevel: "10"
          voltageLevel: "2"
          frequencyMode: "medium"

      # 中→高（提升）
      - group0:
          powerLevel: "10"
          voltageLevel: "2"
          frequencyMode: "medium"
        group1:
          powerLevel: "15"
          voltageLevel: "3"
          frequencyMode: "high"

      # ===== 从高功率(15)可以切换到的配置 =====
      # 高→中（降低，需要过渡）
      - group0:
          powerLevel: "15"
          voltageLevel: "3"
          frequencyMode: "high"
        group1:
          powerLevel: "10"
          voltageLevel: "2"
          frequencyMode: "medium"

      # 高→高（保持）
      - group0:
          powerLevel: "15"
          voltageLevel: "3"
          frequencyMode: "high"
        group1:
          powerLevel: "15"
          voltageLevel: "3"
          frequencyMode: "high"

      # 注意：高→低 不允许（需要先降到中功率）

  # 新增：温度风扇级联控制
  - name: "温度风扇级联控制"
    description: "前后两组的温度阈值和风扇转速必须协调变化"
    group_count: 2

    only_allow_combinations:
      # ===== 从60°C配置可以转换到 =====
      - group0:
          tempThreshold: "60"
          maxPower: "100W"
          fanSpeed: "30%"
        group1:
          tempThreshold: "60"
          maxPower: "100W"
          fanSpeed: "30%"

      - group0:
          tempThreshold: "60"
          maxPower: "100W"
          fanSpeed: "30%"
        group1:
          tempThreshold: "75"
          maxPower: "80W"
          fanSpeed: "60%"

      # ===== 从75°C配置可以转换到 =====
      - group0:
          tempThreshold: "75"
          maxPower: "80W"
          fanSpeed: "60%"
        group1:
          tempThreshold: "60"
          maxPower: "100W"
          fanSpeed: "30%"

      - group0:
          tempThreshold: "75"
          maxPower: "80W"
          fanSpeed: "60%"
        group1:
          tempThreshold: "75"
          maxPower: "80W"
          fanSpeed: "60%"

      - group0:
          tempThreshold: "75"
          maxPower: "80W"
          fanSpeed: "60%"
        group1:
          tempThreshold: "85"
          maxPower: "60W"
          fanSpeed: "100%"

      # ===== 从85°C配置（高温紧急模式）可以转换到 =====
      - group0:
          tempThreshold: "85"
          maxPower: "60W"
          fanSpeed: "100%"
        group1:
          tempThreshold: "75"
          maxPower: "80W"
          fanSpeed: "60%"

      - group0:
          tempThreshold: "85"
          maxPower: "60W"
          fanSpeed: "100%"
        group1:
          tempThreshold: "85"
          maxPower: "60W"
          fanSpeed: "100%"

# ==================== 说明 ====================

# 单组约束类型：
#   - only_allow: 字段只能在指定值列表中
#   - forbid: 字段不能在指定值列表中
#   - only_allow_combinations: 多字段组合只能是指定的组合之一（新增）

# 多组约束类型：
#   - same_value: 连续多组的指定字段值必须相同
#   - sequence: 连续多组的指定字段值必须递增/递减
#   - conditional: 如果某组满足条件，则另一组必须满足约束
#   - only_allow_combinations: 连续多组的字段组合必须是指定的组合对之一（新增）

# 使用建议：
#   1. 单组内多字段必须配套使用 → only_allow_combinations (单组)
#   2. 组间状态转换限制 → only_allow_combinations (多组)
#   3. 简单的字段值限制 → only_allow / forbid
#   4. 组间一致性检查 → same_value / sequence / conditional
