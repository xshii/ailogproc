# 配置约束规则 v1.3.0
# 创建日期: 2024-02-08
# 描述: 所有字段使用带前缀格式，支持子表字段约束

version: "1.3.0"
date: "2024-02-08"
description: "字段统一使用带前缀格式（table.field），支持 top 和 sub 表约束"
author: "Team"
changelog:
  - "所有字段名使用 'sectionName.fieldName' 格式"
  - "支持对子表字段进行约束检查"
  - "不同子表的同名字段可以明确区分"

# ==================== 单组约束 ====================

single_constraints:
  # top 表字段约束（使用前缀）
  - name: "系统模式1下的参数限制"
    description: >
      当系统处于模式1时，限制调试级别和功率模式的取值范围，
      并禁止开启危险标志位，防止在该模式下出现不安全的配置组合
    when:
      opSch.systemMode: "1"
    only_allow:
      opSch.debugLevel: ["0", "1", "2", "3"]
      opSch.powerMode: ["low", "medium", "high"]
    forbid:
      opSch.dangerousFlag: ["1", "true"]

  - name: "高级调试模式的生产配置禁止"
    description: >
      当调试级别为最高级(3)且系统处于模式2时，
      禁止启用生产模式，避免调试配置与生产配置混用导致异常
    when:
      opSch.debugLevel: "3"
      opSch.systemMode: "2"
    forbid:
      opSch.productionMode: ["1", "enabled"]

  # 功率等级组合约束（top 表）
  - name: "功率-电压-频率配套约束"
    description: >
      功率等级、电压等级、频率模式三者必须配套使用，
      防止出现功率与电压/频率不匹配的配置，避免硬件损坏或性能异常
    when:
      opSch.systemMode: "1"

    only_allow_combinations:
      # 低功率配置
      - opSch.powerLevel: "5"
        opSch.voltageLevel: "1"
        opSch.frequencyMode: "low"

      # 中功率配置
      - opSch.powerLevel: "10"
        opSch.voltageLevel: "2"
        opSch.frequencyMode: "medium"

      # 高功率配置
      - opSch.powerLevel: "15"
        opSch.voltageLevel: "3"
        opSch.frequencyMode: "high"

  # 子表字段约束
  - name: "ERCfg 配置组取值范围"
    description: >
      限制 ERCfg 子表的配置组编号在有效范围内（0~4），
      超出范围的配置组编号会导致硬件查表越界
    only_allow:
      ERCfg.cfgGroup: ["0", "1", "2", "3", "4"]

  # 多个子表的同名字段约束
  - name: "I2C 各总线速度限制"
    description: >
      不同 I2C 总线因硬件能力差异，支持的速度模式不同：
      I2C.0 支持标准和快速模式，I2C.1 额外支持高速模式，
      I2C.2 仅支持标准模式。超出支持范围会导致通信失败
    only_allow:
      I2C.0.speed: ["100K", "400K"]      # I2C.0 支持标准和快速模式
      I2C.1.speed: ["100K", "400K", "1M"] # I2C.1 支持高速模式
      I2C.2.speed: ["100K"]               # I2C.2 只支持标准模式

  # 跨 top 和 sub 的组合约束
  - name: "高功率模式下 ERCfg 配置组限制"
    description: >
      高功率模式下只允许使用 ERCfg 配置组 0 和 1，
      因为配置组 2~4 的参数在高功率场景下可能引发过热保护
    when:
      opSch.powerMode: "high"
    only_allow:
      ERCfg.cfgGroup: ["0", "1"]  # 高功率模式只允许配置组 0 和 1

# ==================== 多组约束 ====================

multi_constraints:
  # top 表字段的多组约束（使用前缀）
  - name: "相邻配置组系统模式一致性"
    description: >
      连续两个配置组的系统模式必须相同，
      防止在连续操作中出现模式突变导致系统状态不连续
    group_count: 2
    rules:
      - type: "same_value"
        field: "opSch.systemMode"

  - name: "连续三组配置ID严格递增"
    description: >
      连续三个配置组的 configId 必须严格递增，
      确保配置的执行顺序正确，避免重复或乱序执行
    group_count: 3
    rules:
      - type: "sequence"
        field: "opSch.configId"
        order: "increasing"

  - name: "功率模式级联降档保护"
    description: >
      高功率模式不允许直接切换到低功率模式，必须经过中功率过渡，
      防止功率骤降导致电压跌落或系统不稳定
    group_count: 3
    rules:
      - type: "conditional"
        when_group: 0
        when_field: "opSch.powerMode"
        when_value: "high"
        then_group: 1
        then_field: "opSch.powerMode"
        forbid: ["low"]

      - type: "conditional"
        when_group: 1
        when_field: "opSch.powerMode"
        when_value: "high"
        then_group: 2
        then_field: "opSch.powerMode"
        forbid: ["low"]

  # 子表字段的多组约束
  - name: "ERCfg 配置组递增序列"
    description: >
      连续两组的 ERCfg 配置组编号必须递增，
      确保配置组按顺序加载，避免跳跃式切换导致参数未初始化
    group_count: 2
    rules:
      - type: "sequence"
        field: "ERCfg.cfgGroup"
        order: "increasing"

  # 跨 top 和 sub 的条件约束
  - name: "功率提升时 ERCfg 配置组下限保护"
    description: >
      当从低功率模式切换出去时，下一组的 ERCfg 不能使用配置组 0，
      因为配置组 0 的参数仅适用于低功率场景，在其他场景下可能不安全
    group_count: 2
    rules:
      - type: "conditional"
        when_group: 0
        when_field: "opSch.powerMode"
        when_value: "low"
        then_group: 1
        then_field: "ERCfg.cfgGroup"
        forbid: ["0"]  # 从低功率切换出来时，ERCfg 不能用配置组 0

  # 功率等级切换规则（使用前缀）
  - name: "功率等级切换路径白名单"
    description: >
      定义允许的功率等级切换路径：只允许保持当前等级或相邻等级间切换，
      禁止从高功率直接跳到低功率，防止电压骤降造成硬件损坏
    group_count: 2

    only_allow_combinations:
      # 从低功率(5)可以切换到
      - group0:
          opSch.powerLevel: "5"
          opSch.voltageLevel: "1"
          opSch.frequencyMode: "low"
        group1:
          opSch.powerLevel: "5"
          opSch.voltageLevel: "1"
          opSch.frequencyMode: "low"

      - group0:
          opSch.powerLevel: "5"
          opSch.voltageLevel: "1"
          opSch.frequencyMode: "low"
        group1:
          opSch.powerLevel: "10"
          opSch.voltageLevel: "2"
          opSch.frequencyMode: "medium"

      # 从中功率(10)可以切换到
      - group0:
          opSch.powerLevel: "10"
          opSch.voltageLevel: "2"
          opSch.frequencyMode: "medium"
        group1:
          opSch.powerLevel: "5"
          opSch.voltageLevel: "1"
          opSch.frequencyMode: "low"

      - group0:
          opSch.powerLevel: "10"
          opSch.voltageLevel: "2"
          opSch.frequencyMode: "medium"
        group1:
          opSch.powerLevel: "10"
          opSch.voltageLevel: "2"
          opSch.frequencyMode: "medium"

      - group0:
          opSch.powerLevel: "10"
          opSch.voltageLevel: "2"
          opSch.frequencyMode: "medium"
        group1:
          opSch.powerLevel: "15"
          opSch.voltageLevel: "3"
          opSch.frequencyMode: "high"

      # 从高功率(15)可以切换到
      - group0:
          opSch.powerLevel: "15"
          opSch.voltageLevel: "3"
          opSch.frequencyMode: "high"
        group1:
          opSch.powerLevel: "10"
          opSch.voltageLevel: "2"
          opSch.frequencyMode: "medium"

      - group0:
          opSch.powerLevel: "15"
          opSch.voltageLevel: "3"
          opSch.frequencyMode: "high"
        group1:
          opSch.powerLevel: "15"
          opSch.voltageLevel: "3"
          opSch.frequencyMode: "high"

# ==================== 说明 ====================

# 字段命名规范（v1.3.0 新特性）：
#   所有字段必须使用 "sectionName.fieldName" 格式
#   - top 表字段：opSch.powerLevel, opSch.systemMode
#   - 子表字段：ERCfg.cfgGroup, I2C.0.speed, I2C.1.speed
#
#   优势：
#   1. 明确字段所属的表
#   2. 不同子表的同名字段可以明确区分
#   3. 支持对子表字段进行约束检查

# 单组约束类型：
#   - only_allow: 字段只能在指定值列表中
#   - forbid: 字段不能在指定值列表中
#   - only_allow_combinations: 多字段组合只能是指定的组合之一

# 多组约束类型：
#   - same_value: 连续多组的指定字段值必须相同
#   - sequence: 连续多组的指定字段值必须递增/递减
#   - conditional: 如果某组满足条件，则另一组必须满足约束
#   - only_allow_combinations: 连续多组的字段组合必须是指定的组合对之一

# 使用建议：
#   1. 单组内多字段必须配套使用 → only_allow_combinations (单组)
#   2. 组间状态转换限制 → only_allow_combinations (多组)
#   3. 简单的字段值限制 → only_allow / forbid
#   4. 组间一致性检查 → same_value / sequence / conditional
#   5. 子表字段约束 → 使用 "subTableName.fieldName" 格式（v1.3.0+）
