#!/bin/bash
# ä»£ç è´¨é‡æ£€æŸ¥è„šæœ¬ - æäº¤å‰è¿è¡Œ
# ä½¿ç”¨æ–¹æ³•: ./scripts/check_quality.sh

set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ä»£ç è´¨é‡æ£€æŸ¥"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
if [ -d "venv" ]; then
    source venv/bin/activate
else
    echo "âš ï¸  æœªæ‰¾åˆ°è™šæ‹Ÿç¯å¢ƒï¼Œä½¿ç”¨ç³»ç»ŸPython"
fi

# è¿è¡Œ pylint
echo -e "\nğŸ“Š è¿è¡Œ Pylint..."
pylint src/ --rcfile=config/.pylintrc --exit-zero | tee /tmp/pylint_output.txt

# æå–åˆ†æ•°
SCORE=$(grep "Your code has been rated at" /tmp/pylint_output.txt | sed -n 's/.*rated at \([0-9.]*\)\/10.*/\1/p')

echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ç»“æœæ€»ç»“"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# è®¾ç½®é—¨é™
THRESHOLD=9.5

echo "Pylint åˆ†æ•°: $SCORE / 10"
echo "è´¨é‡é—¨é™: $THRESHOLD / 10"

# ä½¿ç”¨ awk è¿›è¡Œæµ®ç‚¹æ•°æ¯”è¾ƒ
if awk "BEGIN {exit !($SCORE < $THRESHOLD)}"; then
    echo -e "\nâŒ æœªé€šè¿‡è´¨é‡é—¨é™"
    echo "   åˆ†æ•° ($SCORE) ä½äºé—¨é™ ($THRESHOLD)"
    echo -e "\nğŸ’¡ å»ºè®®ï¼š"
    echo "   1. æŸ¥çœ‹ä¸Šæ–¹å‘Šè­¦ä¿¡æ¯"
    echo "   2. ä¿®å¤å…³é”®é—®é¢˜ï¼ˆR/C/Wï¼‰"
    echo "   3. é‡æ–°è¿è¡Œæ£€æŸ¥"
    exit 1
else
    echo -e "\nâœ… é€šè¿‡è´¨é‡é—¨é™"
    echo "   ä»£ç è´¨é‡ç¬¦åˆæ ‡å‡†ï¼"
    exit 0
fi
